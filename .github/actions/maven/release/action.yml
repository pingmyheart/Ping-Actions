name: Maven Release Action

runs:
  using: composite

  steps:
    - name: Configure Git
      shell: bash
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Get release version from pom.xml
      shell: bash
      id: get_release_version
      run: |
        release_version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        clean_version=${release_version%-SNAPSHOT}
        echo "RELEASE_VERSION=$clean_version" >> $GITHUB_ENV
        echo "Release version is $clean_version"

    - name: Set final release version (remove -SNAPSHOT)
      shell: bash
      run: mvn versions:set -DnewVersion=${{ env.RELEASE_VERSION }} -DgenerateBackupPoms=false

    - name: Commit and push release version
      shell: bash
      run: |
        git add .
        git commit -m "[GITHUB ACTION] - Set Release version to ${{ env.RELEASE_VERSION }}"
        git push origin HEAD

    - name: Merge release into main
      shell: bash
      run: |
        git fetch origin main
        git checkout ${{ github.ref_name }}
        git push origin HEAD:main --force

    - name: Checkout develop and bump patch version from release
      shell: bash
      run: |
        git fetch origin develop
        git checkout develop
        git pull origin develop
        
        # Extract version parts
        IFS='.' read -r major minor patch <<<"${{ env.RELEASE_VERSION }}"
        next_patch=$((patch + 1))
        next_version="${major}.${minor}.${next_patch}-SNAPSHOT"
        
        mvn versions:set -DnewVersion=${next_version} -DgenerateBackupPoms=false
        
        git add .
        git commit -m "[GITHUB ACTION] - Update version for next development"
        git push origin develop

    - name: Trigger default workflow on main
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'ci.yml',  // or workflow ID number
            ref: 'refs/heads/main'
          });

    - name: Trigger default workflow on develop
      uses: actions/github-script@v7
      with:
        github-token: ${{ github.token }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'ci.yml',
            ref: 'refs/heads/develop'
          });